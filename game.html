<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Player — Guessing Game</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <main class="page center-col">
    <div class="card player-wrap">
      <h2>Join Game</h2>
      <div class="form-grid">
        <label>Your Display Name</label>
        <input id="name" placeholder="e.g. Player1">

        <label>Game Key</label>
        <input id="key" placeholder="Enter key generated by admin">

        <div class="fullrow">
          <button id="join" class="btn primary">Join Lobby</button>
          <button id="leave" class="btn ghost">Leave</button>
        </div>
      </div>

      <div id="panel" style="display:none" class="card small">
        <h3>Your Panel</h3>
        <div>Player: <strong id="pName"></strong></div>
        <div>Chances left: <strong id="pChances"></strong></div>
        <div>Status: <span id="pStatus" class="muted">Waiting</span></div>

        <div class="top-gap">
          <input id="guess" type="number" min="1" max="100" placeholder="Guess 1-100">
          <button id="doGuess" class="btn">Guess</button>
        </div>

        <div id="log" class="muted top-gap">No guesses yet.</div>
      </div>

      <section class="card small">
        <h3>Lobby Events</h3>
        <div id="events" class="muted"></div>
      </section>

      <div class="foot-actions">
        <a href="index.html" class="muted">← Home</a>
      </div>
    </div>
  </main>

  <script src="app.js"></script>
  <script>
    // Player page logic
    (function(){
      const nameInput = document.getElementById('name');
      const keyInput = document.getElementById('key');
      const joinBtn = document.getElementById('join');
      const leaveBtn = document.getElementById('leave');
      const panel = document.getElementById('panel');
      const pName = document.getElementById('pName');
      const pChances = document.getElementById('pChances');
      const pStatus = document.getElementById('pStatus');
      const guessInput = document.getElementById('guess');
      const doGuess = document.getElementById('doGuess');
      const log = document.getElementById('log');
      const events = document.getElementById('events');

      let myId = null;

      function refreshPanel(){
        if(!myId) return;
        const p = GG.getPlayers().find(x=>x.id===myId);
        if(!p) { panel.style.display='none'; return; }
        panel.style.display='block'; pName.textContent = p.name;
        pChances.textContent = p.chancesLeft;
        pStatus.textContent = GG.isGameRunning()? 'Playing' : 'Waiting';
      }

      function addEvent(txt){
        const d = document.createElement('div'); d.textContent = `[${new Date().toLocaleTimeString()}] ${txt}`;
        events.prepend(d);
      }

      joinBtn.addEventListener('click', ()=>{
        const name = (nameInput.value||'').trim();
        const key = (keyInput.value||'').trim();
        if(!name) return alert('Enter display name');
        const s = GG.getSettings();
        if(!s.gameKey) return alert('Admin has not generated a key yet');
        if(key !== s.gameKey) return alert('Wrong key');
        if(GG.getPlayers().some(p=>p.name===name)) return alert('Name already taken');
        if(GG.getPlayers().length >= s.maxPlayers) return alert('Lobby full');
        const added = GG.addPlayer({name});
        myId = added.id;
        addEvent('You joined the lobby');
        refreshPanel();
      });

      leaveBtn.addEventListener('click', ()=>{
        if(!myId) return;
        GG.removePlayer(myId);
        myId = null;
        panel.style.display='none';
        addEvent('You left the lobby');
      });

      doGuess.addEventListener('click', ()=>{
        if(!myId) return alert('Join first');
        const val = Number(guessInput.value);
        if(!val || val<1 || val>100) return alert('Enter 1-100');
        const res = GG.playerGuess(myId, val);
        log.textContent = res.message;
        refreshPanel();
        if(res.event) addEvent(res.event);
      });

      // sync updates
      GG.onSync(()=>{
        refreshPanel();
        const s = GG.getSettings();
        gameKey.value = s.gameKey || '';
      });

      // initial UI
      refreshPanel();
    })();
  </script>
</body>
</html>